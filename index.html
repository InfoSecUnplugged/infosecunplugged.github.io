<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Info Sec. Unplugged</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <header class="bg-dark text-white text-center py-5">
    <h1>Info Sec. Unplugged</h1>
    <p class="lead">Podcast sulla sicurezza informatica</p>
    <div id="subscribe-buttons" class="d-flex justify-content-center flex-wrap gap-2 mt-3"></div>
  </header>

  <main class="container my-5">
    <h2 class="mb-4">Episodi</h2>
    <div id="episodes-list" class="row g-4"></div>
  </main>

  <footer class="bg-light text-center py-4">
    <p class="mb-0">&copy; 2025 Info Sec. Unplugged</p>
  </footer>

  <script>
    async function loadConfig() {
      const response = await fetch('config.json');
      return response.json();
    }

    async function loadEpisodes() {
      const response = await fetch('episodes.json');
      return response.json();
    }

    function renderSubscribeButtons(config) {
      const container = document.getElementById('subscribe-buttons');
      const platforms = {
        apple: 'Apple Podcasts',
        audible: 'Audible',
        iheartradio: 'iHeartRadio',
        spotify: 'Spotify'
      };

      Object.entries(config).forEach(([key, url]) => {
        if (platforms[key]) {
          const btn = document.createElement('a');
          btn.href = url;
          btn.target = '_blank';
          btn.className = 'btn btn-outline-light';
          btn.textContent = platforms[key];
          container.appendChild(btn);
        }
      });
    }

    function renderEpisodes(episodes) {
      const container = document.getElementById('episodes-list');
      // Filtro per 'published: true'
      const publishedEpisodes = episodes.filter(ep => ep.published);
      publishedEpisodes.forEach(ep => {
        const hexId = ep.id.toString(16);

        const col = document.createElement('div');
        col.className = 'col-md-6';

        const card = document.createElement('div');
        card.className = 'card h-100';

        const cardBody = document.createElement('div');
        cardBody.className = 'card-body d-flex flex-column';

        const title = document.createElement('h5');
        title.className = 'card-title';
        title.textContent = `[0x${hexId}] ${ep.title}`;

        const notes = document.createElement('div');
        notes.className = 'card-text mb-3';
        notes.innerHTML = marked.parse(ep.notes || '');

        // Highlights
        if (ep.highlight_links && ep.highlight_links.length > 0) {
          const highlightsTitle = document.createElement('h6');
          highlightsTitle.textContent = 'Highlights';
          highlightsTitle.className = 'mt-2';
          cardBody.appendChild(highlightsTitle);

          const highlightsList = document.createElement('ul');
          highlightsList.className = 'list-unstyled mb-3';
          ep.highlight_links.forEach(linkObj => {
            const item = document.createElement('li');
            const link = document.createElement('a');
            link.href = linkObj.link;
            link.target = '_blank';
            link.textContent = linkObj.title || linkObj.link;
            item.appendChild(link);
            highlightsList.appendChild(item);
          });
          cardBody.appendChild(highlightsList);
        }

        // Tags
        if (ep.tags && ep.tags.length > 0) {
          const tagsDiv = document.createElement('div');
          tagsDiv.className = 'mb-2';
          ep.tags.forEach(tag => {
            const tagSpan = document.createElement('span');
            tagSpan.className = 'badge bg-secondary me-1';
            tagSpan.textContent = tag;
            tagsDiv.appendChild(tagSpan);
          });
          cardBody.appendChild(tagsDiv);
        }
        
        const link = document.createElement('a');
        link.href = ep.link;
        link.target = '_blank';
        link.className = 'btn btn-primary mt-auto';
        link.textContent = 'Ascolta episodio';

        cardBody.appendChild(title);
        cardBody.appendChild(notes);
        cardBody.appendChild(link);

        card.appendChild(cardBody);
        col.appendChild(card);
        container.appendChild(col);
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const config = await loadConfig();
      renderSubscribeButtons(config);

      const episodes = await loadEpisodes();
      renderEpisodes(episodes.reverse());
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
